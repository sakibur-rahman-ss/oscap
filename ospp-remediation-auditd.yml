---
###############################################################################
#
# Profile ID: xccdf_org.ssgproject.content_profile_ospp_auditd
# XCCDF Version:  1.2
#
# This file was generated by OpenSCAP 1.3.4 using:
# $ oscap xccdf generate fix --result-id xccdf_org.open-scap_testresult_xccdf_org.ssgproject.content_profile_ospp_auditd --fix-type ansible xccdf-results.xml
#
###############################################################################


- hosts: localhost
  vars:
  tasks:
    - name: Ensure audispd-plugins is installed
      package:
        name: audispd-plugins
        state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82953-1
        - enable_strategy
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - package_audispd-plugins_installed


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80825-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-08-030601
        - NIST-800-171-3.3.1
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-14(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IR-5(1)
        - PCI-DSS-Req-10.3
        - grub2_audit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy

    - name: get current kernel parameters
      command: /usr/bin/grub2-editenv - list
      register: kernelopts
      changed_when: false
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"grub2-common" in ansible_facts.packages'
      tags:
        - CCE-80825-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-08-030601
        - NIST-800-171-3.3.1
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-14(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IR-5(1)
        - PCI-DSS-Req-10.3
        - grub2_audit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy

    - name: Update the bootloader menu
      command: /usr/bin/grub2-editenv - set "{{ item }} audit=1"
      with_items: '{{ kernelopts.stdout_lines | select(''match'', ''^kernelopts.*'') |
        list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"grub2-common" in ansible_facts.packages'
        - kernelopts.stdout_lines is defined
        - kernelopts.stdout_lines | length > 0
        - kernelopts.stdout | regex_search('^kernelopts=(?:.*\s)?audit=1(?:\s.*)?$', multiline=True)
          is none
      tags:
        - CCE-80825-3
        - CJIS-5.4.1.1
        - DISA-STIG-RHEL-08-030601
        - NIST-800-171-3.3.1
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-14(1)
        - NIST-800-53-CM-6(a)
        - NIST-800-53-IR-5(1)
        - PCI-DSS-Req-10.3
        - grub2_audit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy


    - name: Gather the package facts
      package_facts:
        manager: auto
      tags:
        - CCE-80943-4
        - DISA-STIG-RHEL-08-030602
        - NIST-800-53-CM-6(a)
        - grub2_audit_backlog_limit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy

    - name: get current kernel parameters
      command: /usr/bin/grub2-editenv - list
      register: kernelopts
      changed_when: false
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"grub2-common" in ansible_facts.packages'
      tags:
        - CCE-80943-4
        - DISA-STIG-RHEL-08-030602
        - NIST-800-53-CM-6(a)
        - grub2_audit_backlog_limit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy

    - name: Update the bootloader menu
      command: /usr/bin/grub2-editenv - set "{{ item }} audit_backlog_limit=8192"
      with_items: '{{ kernelopts.stdout_lines | select(''match'', ''^kernelopts.*'') |
        list }}'
      when:
        - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
        - '"grub2-common" in ansible_facts.packages'
        - kernelopts.stdout_lines is defined
        - kernelopts.stdout_lines | length > 0
        - kernelopts.stdout | regex_search('^kernelopts=(?:.*\s)?audit_backlog_limit=8192(?:\s.*)?$',
          multiline=True) is none
      tags:
        - CCE-80943-4
        - DISA-STIG-RHEL-08-030602
        - NIST-800-53-CM-6(a)
        - grub2_audit_backlog_limit_argument
        - low_disruption
        - medium_complexity
        - medium_severity
        - reboot_required
        - restrict_strategy


    - name: Set hostname as computer node name in audit logs
      block:

        - name: Check for duplicate values
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*name_format\s*=\s*
            state: absent
          check_mode: true
          changed_when: false
          register: dupes

        - name: Deduplicate values from /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: false
            regexp: (?i)^\s*name_format\s*=\s*
            state: absent
          when: dupes.found is defined and dupes.found > 1

        - name: Insert correct line to /etc/audit/auditd.conf
          lineinfile:
            path: /etc/audit/auditd.conf
            create: true
            regexp: (?i)^\s*name_format\s*=\s*
            line: name_format = hostname
            state: present
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82897-0
        - DISA-STIG-RHEL-08-030062
        - auditd_name_format
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-3-access-failed.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-3-access-failed.rules
        content: |
          ## Unsuccessful file access (any other opens) This has to go last.
          -a always,exit -F arch=b32 -S open,openat,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-access
          -a always,exit -F arch=b64 -S open,openat,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-access
          -a always,exit -F arch=b32 -S open,openat,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-access
          -a always,exit -F arch=b64 -S open,openat,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-access
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82833-5
        - NIST-800-53-AU-2(a)
        - audit_access_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-3-access-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82833-5
        - NIST-800-53-AU-2(a)
        - audit_access_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-3-access-success.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-3-access-success.rules
        content: |
          ## Successful file access (any other opens) This has to go last.
          ## These next two are likely to result in a whole lot of events
          -a always,exit -F arch=b32 -S open,openat,open_by_handle_at -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-access
          -a always,exit -F arch=b64 -S open,openat,open_by_handle_at -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-access
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82834-3
        - NIST-800-53-AU-2(a)
        - audit_access_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-3-access-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82834-3
        - NIST-800-53-AU-2(a)
        - audit_access_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/10-base-config.rules according to policy
      copy:
        dest: /etc/audit/rules.d/10-base-config.rules
        content: |
          ## First rule - delete all
          -D

          ## Increase the buffers to survive stress events.
          ## Make this bigger for busy systems
          -b 8192

          ## This determine how long to wait in burst of events
          --backlog_wait_time 60000

          ## Set failure mode to syslog
          -f 1
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82827-7
        - NIST-800-53-AU-2(a)
        - audit_basic_configuration
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/10-base-config.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82827-7
        - NIST-800-53-AU-2(a)
        - audit_basic_configuration
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-1-create-failed.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-1-create-failed.rules
        content: |
          ## Unsuccessful file creation (open with O_CREAT)
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&0100 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&0100 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b32 -S open -F a1&0100 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S open -F a1&0100 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b32 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&0100 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&0100 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b32 -S open -F a1&0100 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S open -F a1&0100 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b32 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
          -a always,exit -F arch=b64 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-create
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82374-0
        - NIST-800-53-AU-2(a)
        - audit_create_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-1-create-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82374-0
        - NIST-800-53-AU-2(a)
        - audit_create_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-1-create-success.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-1-create-success.rules
        content: |
          ## Successful file creation (open with O_CREAT)
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&0100 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&0100 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
          -a always,exit -F arch=b32 -S open -F a1&0100 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
          -a always,exit -F arch=b64 -S open -F a1&0100 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
          -a always,exit -F arch=b32 -S creat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
          -a always,exit -F arch=b64 -S creat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-create
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82829-3
        - NIST-800-53-AU-2(a)
        - audit_create_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-1-create-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82829-3
        - NIST-800-53-AU-2(a)
        - audit_create_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-4-delete-failed.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-4-delete-failed.rules
        content: |
          ## Unsuccessful file delete
          -a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-delete
          -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-delete
          -a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-delete
          -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-delete
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82835-0
        - NIST-800-53-AU-2(a)
        - audit_delete_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-4-delete-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82835-0
        - NIST-800-53-AU-2(a)
        - audit_delete_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-4-delete-success.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-4-delete-success.rules
        content: |
          ## Successful file delete
          -a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-delete
          -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-delete
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82836-8
        - NIST-800-53-AU-2(a)
        - audit_delete_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-4-delete-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82836-8
        - NIST-800-53-AU-2(a)
        - audit_delete_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/11-loginuid.rules according to policy
      copy:
        dest: /etc/audit/rules.d/11-loginuid.rules
        content: |
          ## Make the loginuid immutable. This prevents tampering with the auid.
          --loginuid-immutable
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82828-5
        - DISA-STIG-RHEL-08-030122
        - NIST-800-53-AU-2(a)
        - audit_immutable_login_uids
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/11-loginuid.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82828-5
        - DISA-STIG-RHEL-08-030122
        - NIST-800-53-AU-2(a)
        - audit_immutable_login_uids
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-2-modify-failed.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-2-modify-failed.rules
        content: |
          ## Unsuccessful file modifications (open for write or truncate)
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&01003 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&01003 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b32 -S open -F a1&01003 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S open -F a1&01003 -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b32 -S truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S truncate,ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&01003 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&01003 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b32 -S open -F a1&01003 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S open -F a1&01003 -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b32 -S truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
          -a always,exit -F arch=b64 -S truncate,ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-modification
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82830-1
        - NIST-800-53-AU-2(a)
        - audit_modify_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-2-modify-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82830-1
        - NIST-800-53-AU-2(a)
        - audit_modify_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-2-modify-success.rules according
        to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-2-modify-success.rules
        content: |
          ## Successful file modifications (open for write or truncate)
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&01003 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&01003 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
          -a always,exit -F arch=b32 -S open -F a1&01003 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
          -a always,exit -F arch=b64 -S open -F a1&01003 -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
          -a always,exit -F arch=b32 -S truncate,ftruncate -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
          -a always,exit -F arch=b64 -S truncate,ftruncate -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-modification
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82832-7
        - NIST-800-53-AU-2(a)
        - audit_modify_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-2-modify-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82832-7
        - NIST-800-53-AU-2(a)
        - audit_modify_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/43-module-load.rules according to policy
      copy:
        dest: /etc/audit/rules.d/43-module-load.rules
        content: |
          ## These rules watch for kernel module insertion. By monitoring
          ## the syscall, we do not need any watches on programs.
          -a always,exit -F arch=b32 -S init_module,finit_module -F key=module-load
          -a always,exit -F arch=b64 -S init_module,finit_module -F key=module-load
          -a always,exit -F arch=b32 -S delete_module -F key=module-unload
          -a always,exit -F arch=b64 -S delete_module -F key=module-unload
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82838-4
        - NIST-800-53-AU-2(a)
        - audit_module_load
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/43-module-load.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82838-4
        - NIST-800-53-AU-2(a)
        - audit_module_load
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42.rules according to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42.rules
        content: |
          ## The purpose of these rules is to meet the requirements for Operating
          ## System Protection Profile (OSPP)v4.2. These rules depends on having
          ## the following rule files copied to /etc/audit/rules.d:
          ##
          ## 10-base-config.rules, 11-loginuid.rules,
          ## 30-ospp-v42-1-create-failed.rules, 30-ospp-v42-1-create-success.rules,
          ## 30-ospp-v42-2-modify-failed.rules, 30-ospp-v42-2-modify-success.rules,
          ## 30-ospp-v42-3-access-failed.rules, 30-ospp-v42-3-access-success.rules,
          ## 30-ospp-v42-4-delete-failed.rules, 30-ospp-v42-4-delete-success.rules,
          ## 30-ospp-v42-5-perm-change-failed.rules,
          ## 30-ospp-v42-5-perm-change-success.rules,
          ## 30-ospp-v42-6-owner-change-failed.rules,
          ## 30-ospp-v42-6-owner-change-success.rules
          ##
          ## original copies may be found in /usr/share/audit/sample-rules/


          ## User add delete modify. This is covered by pam. However, someone could
          ## open a file and directly create or modify a user, so we'll watch passwd and
          ## shadow for writes
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&03 -F path=/etc/passwd -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&03 -F path=/etc/passwd -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b32 -S open -F a1&03 -F path=/etc/passwd -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b64 -S open -F a1&03 -F path=/etc/passwd -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b32 -S openat,open_by_handle_at -F a2&03 -F path=/etc/shadow -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b64 -S openat,open_by_handle_at -F a2&03 -F path=/etc/shadow -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b32 -S open -F a1&03 -F path=/etc/shadow -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F arch=b64 -S open -F a1&03 -F path=/etc/shadow -F auid>=1000 -F auid!=unset -F key=user-modify

          ## User enable and disable. This is entirely handled by pam.

          ## Group add delete modify. This is covered by pam. However, someone could
          ## open a file and directly create or modify a user, so we'll watch group and
          ## gshadow for writes
          -a always,exit -F path=/etc/passwd -F perm=wa -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F path=/etc/shadow -F perm=wa -F auid>=1000 -F auid!=unset -F key=user-modify
          -a always,exit -F path=/etc/group -F perm=wa -F auid>=1000 -F auid!=unset -F key=group-modify
          -a always,exit -F path=/etc/gshadow -F perm=wa -F auid>=1000 -F auid!=unset -F key=group-modify


          ## Use of special rights for config changes. This would be use of setuid
          ## programs that relate to user accts. This is not all setuid apps because
          ## requirements are only for ones that affect system configuration.
          -a always,exit -F path=/usr/sbin/unix_chkpwd -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/sbin/usernetctl -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/sbin/userhelper -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/sbin/seunshare -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/mount -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/newgrp -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/newuidmap -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/gpasswd -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/newgidmap -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/umount -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/crontab -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes
          -a always,exit -F path=/usr/bin/at -F perm=x -F auid>=1000 -F auid!=unset -F key=special-config-changes

          ## Privilege escalation via su or sudo. This is entirely handled by pam.

          ## Audit log access
          -a always,exit -F dir=/var/log/audit/ -F perm=r -F auid>=1000 -F auid!=unset -F key=access-audit-trail
          ## Attempts to Alter Process and Session Initiation Information
          -a always,exit -F path=/var/run/utmp -F perm=wa -F auid>=1000 -F auid!=unset -F key=session
          -a always,exit -F path=/var/log/btmp -F perm=wa -F auid>=1000 -F auid!=unset -F key=session
          -a always,exit -F path=/var/log/wtmp -F perm=wa -F auid>=1000 -F auid!=unset -F key=session

          ## Attempts to modify MAC controls
          -a always,exit -F dir=/etc/selinux/ -F perm=wa -F auid>=1000 -F auid!=unset -F key=MAC-policy

          ## Software updates. This is entirely handled by rpm.

          ## System start and shutdown. This is entirely handled by systemd

          ## Kernel Module loading. This is handled in 43-module-load.rules

          ## Application invocation. The requirements list an optional requirement
          ## FPT_SRP_EXT.1 Software Restriction Policies. This event is intended to
          ## state results from that policy. This would be handled entirely by
          ## that daemon.
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82373-2
        - NIST-800-53-AU-2(a)
        - audit_ospp_general
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82373-2
        - NIST-800-53-AU-2(a)
        - audit_ospp_general
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-6-owner-change-failed.rules
        according to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-6-owner-change-failed.rules
        content: |
          ## Unsuccessful ownership change
          -a always,exit -F arch=b32 -S lchown,fchown,chown,fchownat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-owner-change
          -a always,exit -F arch=b64 -S lchown,fchown,chown,fchownat -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-owner-change
          -a always,exit -F arch=b32 -S lchown,fchown,chown,fchownat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-owner-change
          -a always,exit -F arch=b64 -S lchown,fchown,chown,fchownat -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-owner-change
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82384-9
        - NIST-800-53-AU-2(a)
        - audit_owner_change_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-6-owner-change-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82384-9
        - NIST-800-53-AU-2(a)
        - audit_owner_change_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-6-owner-change-success.rules
        according to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-6-owner-change-success.rules
        content: |
          ## Successful ownership change
          -a always,exit -F arch=b32 -S lchown,fchown,chown,fchownat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-owner-change
          -a always,exit -F arch=b64 -S lchown,fchown,chown,fchownat -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-owner-change
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82385-6
        - NIST-800-53-AU-2(a)
        - audit_owner_change_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-6-owner-change-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82385-6
        - NIST-800-53-AU-2(a)
        - audit_owner_change_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-5-perm-change-failed.rules
        according to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-5-perm-change-failed.rules
        content: |
          ## Unsuccessful permission change
          -a always,exit -F arch=b32 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-perm-change
          -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F exit=-EACCES -F auid>=1000 -F auid!=unset -F key=unsuccessful-perm-change
          -a always,exit -F arch=b32 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-perm-change
          -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F exit=-EPERM -F auid>=1000 -F auid!=unset -F key=unsuccessful-perm-change
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82837-6
        - NIST-800-53-AU-2(a)
        - audit_perm_change_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-5-perm-change-failed.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82837-6
        - NIST-800-53-AU-2(a)
        - audit_perm_change_failed
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


    - name: Put contents into /etc/audit/rules.d/30-ospp-v42-5-perm-change-success.rules
        according to policy
      copy:
        dest: /etc/audit/rules.d/30-ospp-v42-5-perm-change-success.rules
        content: |
          ## Successful permission change
          -a always,exit -F arch=b32 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-perm-change
          -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat,setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F success=1 -F auid>=1000 -F auid!=unset -F key=successful-perm-change
        force: true
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82383-1
        - NIST-800-53-AU-2(a)
        - audit_perm_change_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy

    - name: Remove any permissions from other group
      file:
        path: /etc/audit/rules.d/30-ospp-v42-5-perm-change-success.rules
        mode: o-rwx
      when: ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
        - CCE-82383-1
        - NIST-800-53-AU-2(a)
        - audit_perm_change_success
        - low_complexity
        - low_disruption
        - medium_severity
        - no_reboot_needed
        - restrict_strategy


